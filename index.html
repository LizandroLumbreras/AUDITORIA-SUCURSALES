<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auditor√≠a de Sucursales ‚Äî PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{--azul:#00416A;--resalte:#0c6cbd;--card:#ffffffcc;--radius:12px}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(90deg,#f4f7fa,#fff);color:#111;padding:18px}
header{display:flex;align-items:center;gap:12px}
header img{height:56px}
.wrap{max-width:1100px;margin:18px auto}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
label{display:block;font-size:13px;color:#333;margin-bottom:6px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
.toolbar{display:flex;gap:8px}
.small{font-size:13px;padding:8px}
.list{max-height:420px;overflow:auto}
.item{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee}
.item img{height:64px;width:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
.muted{color:#666;font-size:13px}
.watermark{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);opacity:.06;font-size:120px;color:#00416A;pointer-events:none;user-select:none}
@media(max-width:900px){.grid{grid-template-columns:1fr;}.watermark{font-size:72px}}
</style>
</head>

<body>
<div class="watermark">PROVSOFT</div>
<div class="wrap">

<header>
  <img src="logo.png" alt="logo" onerror="this.style.display='none'">
  <div>
    <h2 style="margin:0;color:var(--azul)">Auditor√≠a de Sucursales</h2>
    <div class="muted">Toma fotos, revisa existencias y genera reportes PDF</div>
  </div>
</header>

<div class="grid">

<!-- ===================== COLUMNA IZQUIERDA ===================== -->
<div>

  <div class="card">
    <label>Sucursal</label>
    <select id="sucursal">
      <option value="osito">Osito</option>
      <option value="provileon">Provile√≥n</option>
      <option value="rioverde">R√≠o Verde</option>
      <option value="central">Central</option>
      <option value="montemorelos">Montemorelos</option>
      <option value="allende1">Allende 1</option>
      <option value="allende2">Allende 2</option>
    </select>

    <label style="margin-top:10px">Encargado / Auditor</label>
    <input id="auditor" placeholder="Nombre del auditor" />

    <label style="margin-top:10px">Fecha</label>
    <input id="fecha" type="date" />

    <div style="margin-top:10px" class="toolbar">
      <button id="nuevaVisita" class="small">Nueva visita</button>
      <button id="guardarVisita" class="small">Guardar</button>
      <button id="generarPDF" class="small">Generar PDF</button>
    </div>
  </div>

  <div class="card">
    <label>Buscar producto por c√≥digo o descripci√≥n</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="buscador" placeholder="C√≥digo o descripci√≥n" />
      <button id="buscarCamara" class="small" style="width:44px">üì∑</button>
      <input id="scanFile" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="cantidad" type="number" step="0.001" min="0" placeholder="Cantidad" />
      <button id="agregarProd" class="small">Agregar</button>
    </div>

    <div style="margin-top:12px">
      <label>Lista de art√≠culos revisados</label>
      <div id="lista" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Notas generales</label>
    <textarea id="notas" rows="4"></textarea>
  </div>

</div>

<!-- ===================== COLUMNA DERECHA ===================== -->
<div>

  <div class="card">
    <label>Capturar evidencia (foto)</label>
    <video id="preview" autoplay playsinline style="width:100%;border-radius:8px;display:none"></video>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="abrirCamara" class="small">Abrir C√°mara</button>
      <input id="filePhoto" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="subirDesdeArchivo" class="small">Desde archivo</button>
      <button id="capturar" class="small">Capturar</button>
    </div>

    <div style="margin-top:10px">
      <label>Fotos guardadas</label>
      <div id="photos" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Resumen</label>
    <div id="resumen" class="muted">No hay visitas guardadas.</div>
  </div>

</div>

</div> <!-- GRID -->
</div><!-- WRAP -->

<!-- FIREBASE -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>

// ======================= PRODUCTOS =========================

let productos = [];

// Cargar productos activos desde Firestore
async function loadProductos(){
  try {
    const snap = await db.collection("productos")
      .where("activo", "==", true)
      .get();

    productos = snap.docs.map(doc => {
      const d = doc.data();
      return {
        codigo: String(d.codigoBarra || doc.id).trim(),
        descripcion: (d.concepto || "").trim(),
        equivalentes: Array.isArray(d.codigosEquivalentes)
          ? d.codigosEquivalentes.map(x => String(x).trim())
          : []
      };
    });

    console.log("Productos cargados:", productos.length);

  } catch (e) {
    console.error("Error al cargar productos:", e);
  }
}

loadProductos();


// =================== BUSCADOR INTELIGENTE ====================
// Incluye:
// ‚úî C√≥digo exacto
// ‚úî Equivalentes exactos
// ‚úî Descripci√≥n parcial
// ‚úî No sobrescribe mientras escribes
// ‚úî Autocompleta solo cuando hay 1 coincidencia clara

buscador.addEventListener("input", () => {
  const texto = buscador.value.trim().toLowerCase();
  if (!texto) return;

  let resultado = [];

  // 1. Coincidencia por c√≥digo exacto
  resultado = productos.filter(p =>
    p.codigo.toLowerCase() === texto ||
    p.equivalentes.some(eq => eq.toLowerCase() === texto)
  );

  if (resultado.length === 1) {
    const p = resultado[0];
    buscador.value = `${p.codigo}|${p.descripcion}`;
    return;
  }


  // 2. Coincidencia por descripci√≥n parcial
  const parciales = productos.filter(p =>
    p.descripcion.toLowerCase().includes(texto)
  );

  // Si solo hay 1 coincidencia por descripci√≥n, autocompleta
  if (parciales.length === 1) {
    const p = parciales[0];
    buscador.value = `${p.codigo}|${p.descripcion}`;
    return;
  }

  // Si hay muchas coincidencias, no autocompleta (para no estorbar)
  // Pero s√≠ puedes verlas en consola si quieres:
  console.log("Coincidencias:", parciales.length);
});


// =================== AGREGAR PRODUCTO ====================

agregarProd.onclick = () => {
  const q = buscador.value.trim();
  const c = parseFloat(cantidad.value) || 0;

  if (!q || c <= 0)
    return alert("Ingresa producto y cantidad v√°lida");

  const [codigo, descripcion] = q.includes("|")
    ? q.split("|")
    : [q, q];

  currentItems.push({
    codigo: codigo.trim(),
    descripcion: descripcion.trim(),
    cantidad: c
  });

  buscador.value = "";
  cantidad.value = "";
  renderLista();
};

</script>
</body>
</html>

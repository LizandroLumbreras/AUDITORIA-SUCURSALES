<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auditor√≠a de Sucursales ‚Äî PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{--azul:#00416A;--resalte:#0c6cbd;--card:#ffffffcc;--radius:12px}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(90deg,#f4f7fa,#fff);color:#111;padding:18px}
header{display:flex;align-items:center;gap:12px}
header img{height:56px}
.wrap{max-width:1100px;margin:18px auto}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
label{display:block;font-size:13px;color:#333;margin-bottom:6px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
.toolbar{display:flex;gap:8px}
.small{font-size:13px;padding:8px}
.list{max-height:420px;overflow:auto}
.item{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee}
.item img{height:64px;width:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
.muted{color:#666;font-size:13px}
.watermark{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);opacity:.06;font-size:120px;color:#00416A;pointer-events:none;user-select:none}
@media(max-width:900px){.grid{grid-template-columns:1fr;}.watermark{font-size:72px}}
</style>
</head>

<body>
<div class="watermark">PROVSOFT</div>
<div class="wrap">

<header>
  <img src="logo.png" alt="logo" onerror="this.style.display='none'">
  <div>
    <h2 style="margin:0;color:var(--azul)">Auditor√≠a de Sucursales</h2>
    <div class="muted">Toma fotos, revisa existencias y genera reportes PDF</div>
  </div>
</header>

<div class="grid">

<!-- ===================== COLUMNA IZQUIERDA ===================== -->
<div>

  <div class="card">
    <label>Sucursal</label>
    <select id="sucursal">
      <option value="osito">Osito</option>
      <option value="provileon">Provile√≥n</option>
      <option value="rioverde">R√≠o Verde</option>
      <option value="central">Central</option>
      <option value="montemorelos">Montemorelos</option>
      <option value="allende1">Allende 1</option>
      <option value="allende2">Allende 2</option>
    </select>

    <label style="margin-top:10px">Encargado / Auditor</label>
    <input id="auditor" placeholder="Nombre del auditor" />

    <label style="margin-top:10px">Fecha</label>
    <input id="fecha" type="date" />

    <div style="margin-top:10px" class="toolbar">
      <button id="nuevaVisita" class="small">Nueva visita</button>
      <button id="guardarVisita" class="small">Guardar</button>
      <button id="generarPDF" class="small">Generar PDF</button>
    </div>
  </div>

  <div class="card">
    <label>Buscar producto por c√≥digo o descripci√≥n</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="buscador" placeholder="C√≥digo o descripci√≥n" />
      <button id="buscarCamara" class="small" style="width:44px">üì∑</button>
      <input id="scanFile" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="cantidad" type="number" step="0.001" min="0" placeholder="Cantidad" />
      <button id="agregarProd" class="small">Agregar</button>
    </div>

    <div style="margin-top:12px">
      <label>Lista de art√≠culos revisados</label>
      <div id="lista" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Notas generales</label>
    <textarea id="notas" rows="4"></textarea>
  </div>

</div>

<!-- ===================== COLUMNA DERECHA ===================== -->
<div>

  <div class="card">
    <label>Capturar evidencia (foto)</label>
    <video id="preview" autoplay playsinline style="width:100%;border-radius:8px;display:none"></video>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="abrirCamara" class="small">Abrir C√°mara</button>
      <input id="filePhoto" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="subirDesdeArchivo" class="small">Desde archivo</button>
      <button id="capturar" class="small">Capturar</button>
    </div>

    <div style="margin-top:10px">
      <label>Fotos guardadas</label>
      <div id="photos" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Resumen</label>
    <div id="resumen" class="muted">No hay visitas guardadas.</div>
  </div>

</div>

</div> <!-- GRID -->
</div><!-- WRAP -->

<!-- FIREBASE -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
/* ====================== FIREBASE ====================== */

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= VARIABLES ================= */
let currentItems = [];
let currentPhotos = [];
let stream = null;

const buscador = document.getElementById("buscador");
const cantidadEl = document.getElementById("cantidad");

/* Fecha por defecto */
document.getElementById("fecha").value = new Date().toISOString().slice(0,10);

/* ================= CARGA DE PRODUCTOS ================= */

let productos = [];

async function loadProductos(){
  const snap = await db.collection("productos")
                       .where("activo","==",true)
                       .get();

  productos = snap.docs.map(doc=>{
    const d = doc.data();
    return {
      codigo: String(d.codigoBarra || doc.id).trim(),
      descripcion: d.concepto || "",
      equivalentes: Array.isArray(d.codigosEquivalentes)
                    ? d.codigosEquivalentes.map(x => String(x).trim())
                    : []
    };
  });

  console.log("Productos cargados:", productos.length);
}
loadProductos();

/* ================= BUSCADOR AVANZADO ================= */

buscador.addEventListener("input", ()=>{
  const q = buscador.value.toLowerCase().trim();
  if(!q) return;

  // Autocompletar SOLO si es un c√≥digo completo
  if(q.length >= 8){
    const found = productos.find(p =>
      p.codigo.toLowerCase() === q ||
      p.equivalentes.some(eq => eq.toLowerCase() === q)
    );

    if(found){
      buscador.value = `${found.codigo}|${found.descripcion}`;
    }
  }
});

/* ================= LISTA ================= */

function renderLista(){
  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  currentItems.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
      <div style="flex:1">
        <strong>${it.codigo}</strong>
        <div class="muted">${it.descripcion}</div>
        <div class="muted">Cant: ${it.cantidad}</div>
      </div>
    `;

    const del = document.createElement("button");
    del.className = "small";
    del.textContent = "Eliminar";
    del.onclick = ()=>{ currentItems.splice(i,1); renderLista(); };

    div.appendChild(del);
    lista.appendChild(div);
  });
}

document.getElementById("agregarProd").onclick = ()=>{
  const q = buscador.value.trim();
  const c = parseFloat(cantidadEl.value) || 0;
  if(!q || c<=0) return alert("Ingresa producto y cantidad v√°lida");

  const [codigo, descripcion] = q.includes("|") ? q.split("|") : [q,q];

  currentItems.push({
    codigo: codigo.trim(),
    descripcion: descripcion.trim(),
    cantidad: c
  });

  buscador.value = "";
  cantidadEl.value = "";
  renderLista();
};

/* ================= FOTOS ================= */

document.getElementById("abrirCamara").onclick = async()=>{
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
    document.getElementById("preview").style.display="none";
    return;
  }

  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  const v = document.getElementById("preview");
  v.srcObject = stream;
  v.style.display="block";
};

document.getElementById("capturar").onclick = ()=>{
  if(!stream) return;

  const v = document.getElementById("preview");
  const canvas = document.createElement("canvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  canvas.getContext("2d").drawImage(v,0,0);

  addPhoto(canvas.toDataURL("image/jpeg",0.75));
};

document.getElementById("subirDesdeArchivo").onclick = ()=> 
  document.getElementById("filePhoto").click();

document.getElementById("filePhoto").onchange = e=>{
  const f = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ()=> addPhoto(reader.result);
  reader.readAsDataURL(f);
};

function addPhoto(data){
  currentPhotos.push({data,ts:Date.now()});
  renderPhotos();
}

function renderPhotos(){
  const cont = document.getElementById("photos");
  cont.innerHTML="";

  currentPhotos.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="item";

    div.innerHTML=`
      <img src="${p.data}">
      <div style="flex:1" class="muted">${new Date(p.ts).toLocaleString()}</div>
    `;

    const del=document.createElement("button");
    del.className="small";
    del.textContent="Eliminar";
    del.onclick=()=>{currentPhotos.splice(i,1);renderPhotos();};

    div.appendChild(del);
    cont.appendChild(div);
  });
}

/* ================= GUARDAR AUDITOR√çA ================= */

function dataURLtoBlob(dataurl){
  const arr=dataurl.split(','), mime=arr[0].match(/:(.*?);/)[1];
  const bstr=atob(arr[1]); let n=bstr.length;
  const u8=new Uint8Array(n);
  while(n--)u8[n]=bstr.charCodeAt(n);
  return new Blob([u8],{type:mime});
}

function genId(suc){
  const f=new Date();
  return `AUD-${suc}-${f.getFullYear()}${f.getMonth()+1}${f.getDate()}-${f.getHours()}${f.getMinutes()}${f.getSeconds()}`;
}

document.getElementById("guardarVisita").onclick = async()=>{

  const auditor=document.getElementById("auditor").value.trim();
  if(!auditor) return alert("Ingresa auditor");
  if(currentItems.length === 0) return alert("Agrega art√≠culos");

  const suc=document.getElementById("sucursal").value;
  const id=genId(suc);

  const ref=db.collection("auditorias")
              .doc(suc)
              .collection("registros")
              .doc(id);

  await ref.set({
    sucursal:suc,
    auditor,
    fecha:document.getElementById("fecha").value,
    notas:document.getElementById("notas").value.trim(),
    items:currentItems,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  // fotos
  for(let i=0;i<currentPhotos.length;i++){
    const blob=dataURLtoBlob(currentPhotos[i].data);
    const filePath=`auditorias/${suc}/${id}/photos/${Date.now()}_${i}.jpg`;

    const snap=await storage.ref(filePath).put(blob);
    const url=await snap.ref.getDownloadURL();

    await ref.collection("photos").add({url, ts:Date.now()});
  }

  document.getElementById("resumen").textContent = `Guardado: ${id}`;
  alert("Auditor√≠a guardada");
};

/* ================= PDF ================= */

document.getElementById("generarPDF").onclick = ()=>{
  if(currentItems.length===0 && currentPhotos.length===0)
    return alert("Nada que exportar");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","pt","a4");

  pdf.setFont("Helvetica");
  pdf.setFontSize(18);
  pdf.text("Auditor√≠a",40,50);

  pdf.setFontSize(12);
  pdf.text(`Sucursal: ${document.getElementById("sucursal").value}`,40,80);
  pdf.text(`Auditor: ${document.getElementById("auditor").value}`,40,100);
  pdf.text(`Fecha: ${document.getElementById("fecha").value}`,40,120);

  let y=150;
  pdf.setFontSize(14);
  pdf.text("Productos:",40,y); y+=20;

  pdf.setFontSize(11);
  currentItems.forEach((it,i)=>{
    pdf.text(`${i+1}. ${it.codigo} ‚Äì ${it.descripcion}  Cant: ${it.cantidad}`,40,y);
    y+=14;
    if(y>740){pdf.addPage();y=40;}
  });

  if(currentPhotos.length){
    pdf.addPage();y=40;
    pdf.setFontSize(14);
    pdf.text("Fotos:",40,y); y+=20;

    currentPhotos.forEach(p=>{
      try{
        pdf.addImage(p.data,"JPEG",40,y,220,150);
      }catch{}
      y+=170;
      if(y>720){pdf.addPage();y=40;}
    });
  }

  pdf.save("auditoria.pdf");
};

/* ================= NUEVA VISITA ================= */

document.getElementById("nuevaVisita").onclick=()=>{
  currentItems=[];
  currentPhotos=[];
  renderLista();
  renderPhotos();
  document.getElementById("notas").value="";
  document.getElementById("auditor").value="";
  document.getElementById("resumen").textContent="Lista vac√≠a.";
};

</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auditor√≠a de Sucursales ‚Äî PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{--azul:#00416A;--resalte:#0c6cbd;--card:#ffffffcc;--radius:12px}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(90deg,#f4f7fa,#fff);color:#111;padding:18px}
header{display:flex;align-items:center;gap:12px}
header img{height:56px}
.wrap{max-width:1100px;margin:18px auto}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
label{display:block;font-size:13px;color:#333;margin-bottom:6px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
.toolbar{display:flex;gap:8px}
.small{font-size:13px;padding:8px}
.list{max-height:420px;overflow:auto}
.item{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #eee}
.item img{height:64px;width:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
.muted{color:#666;font-size:13px}
.watermark{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);opacity:.06;font-size:120px;color:#00416A;pointer-events:none;user-select:none}
@media(max-width:900px){.grid{grid-template-columns:1fr;}.watermark{font-size:72px}}
</style>
</head>

<body>
<div class="watermark">PROVSOFT</div>
<div class="wrap">

<header>
  <img src="logo.png" alt="logo" onerror="this.style.display='none'">
  <div>
    <h2 style="margin:0;color:var(--azul)">Auditor√≠a de Sucursales</h2>
    <div class="muted">Toma fotos, revisa existencias y genera reportes PDF</div>
  </div>
</header>

<div class="grid">

<!-- ===================================== -->
<!-- ============ COLUMNA IZQUIERDA ======= -->
<!-- ===================================== -->
<div>

  <div class="card">
    <label>Sucursal</label>
    <select id="sucursal">
      <option value="osito">Osito</option>
      <option value="provileon">Provile√≥n</option>
      <option value="rioverde">R√≠o Verde</option>
      <option value="central">Central</option>
      <option value="montemorelos">Montemorelos</option>
      <option value="allende1">Allende 1</option>
      <option value="allende2">Allende 2</option>
    </select>

    <label style="margin-top:10px">Encargado / Auditor</label>
    <input id="auditor" placeholder="Nombre del auditor" />

    <label style="margin-top:10px">Fecha</label>
    <input id="fecha" type="date" />

    <div style="margin-top:10px" class="toolbar">
      <button id="nuevaVisita" class="small">Nueva visita</button>
      <button id="guardarVisita" class="small">Guardar</button>
      <button id="generarPDF" class="small">Generar PDF</button>
    </div>
  </div>

  <div class="card">

    <label>Buscar producto por c√≥digo o descripci√≥n</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="buscador" placeholder="C√≥digo o descripci√≥n" />
      <button id="buscarCamara" class="small" title="Buscar por c√°mara" style="width:44px;padding:8px">üì∑</button>
      <input id="scanFile" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="cantidad" type="number" step="0.001" min="0" placeholder="Cantidad" />
      <button id="agregarProd" class="small">Agregar</button>
    </div>

    <div style="margin-top:12px">
      <label>Lista de art√≠culos revisados</label>
      <div id="lista" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Notas generales</label>
    <textarea id="notas" rows="4" placeholder="Observaciones, humedad, falta de iluminaci√≥n, etc."></textarea>
  </div>

</div>




<!-- ===================================== -->
<!-- ============ COLUMNA DERECHA ========= -->
<!-- ===================================== -->
<div>

  <div class="card">
    <label>Capturar evidencia (foto)</label>
    <video id="preview" autoplay playsinline style="width:100%;border-radius:8px;display:none"></video>
    <img id="thumb" style="width:100%;border-radius:8px;display:none" />

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="abrirCamara" class="small">Abrir C√°mara</button>
      <input id="filePhoto" type="file" accept="image/*" capture="environment" style="display:none" />
      <button id="subirDesdeArchivo" class="small">Desde archivo</button>
      <button id="capturar" class="small">Capturar</button>
    </div>

    <div style="margin-top:10px">
      <label>Fotos guardadas</label>
      <div id="photos" class="list"></div>
    </div>
  </div>

  <div class="card">
    <label>Resumen</label>
    <div id="resumen" class="muted">No hay visitas guardadas.</div>
  </div>

</div>

</div> <!-- FIN GRID -->

</div><!-- wrap -->

<!-- ================= LIBRER√çAS ================= -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>


<script>
/* =====================================================
   =============== CONFIG FIREBASE =====================
   ===================================================== */

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
  
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();




/* =====================================================
   =============== VARIABLES GLOBALES ==================
   ===================================================== */

const sucursalEl = document.getElementById('sucursal');
const auditorEl = document.getElementById('auditor');
const fechaEl = document.getElementById('fecha');
const buscador = document.getElementById('buscador');
const cantidadEl = document.getElementById('cantidad');
const agregarBtn = document.getElementById('agregarProd');
const listaEl = document.getElementById('lista');
const notasEl = document.getElementById('notas');
const resumenEl = document.getElementById('resumen');

const abrirCamaraBtn = document.getElementById('abrirCamara');
const capturarBtn = document.getElementById('capturar');
const subirDesdeArchivo = document.getElementById('subirDesdeArchivo');
const filePhoto = document.getElementById('filePhoto');
const preview = document.getElementById('preview');
const thumb = document.getElementById('thumb');
const photosEl = document.getElementById('photos');

let currentItems = [];
let currentPhotos = [];
let stream = null;

/* Fecha actual */
fechaEl.value = new Date().toISOString().slice(0,10);




/* =====================================================
   =============== CARGA DE PRODUCTOS ==================
   ===================================================== */

let productos = [];

async function loadProductos(){
  try{
    const snap = await db.collection("productos")
      .where("activo","==",true)
      .get();

    productos = [];

    snap.forEach(doc=>{
      const d = doc.data();
      productos.push({
        codigo: d.codigoBarra || doc.id,
        descripcion: d.concepto || "",
        equivalentes: d.codigosEquivalentes || [],
      });
    });

    console.log("Productos cargados:", productos.length);

  }catch(e){
    console.error("Error cargando productos:", e);
  }
}

loadProductos();




/* =====================================================
   =========== BUSCADOR INTELIGENTE ====================
   ===================================================== */

buscador.addEventListener("input", ()=>{
  const q = buscador.value.toLowerCase();
  if(!q) return;

  const found = productos.find(p =>
    p.codigo.toLowerCase() === q ||
    p.descripcion.toLowerCase().includes(q) ||
    p.equivalentes.some(eq => eq.toLowerCase() === q)
  );

  if(found){
    buscador.value = `${found.codigo}|${found.descripcion}`;
  }
});




/* =====================================================
   =============== LISTA DE ART√çCULOS ==================
   ===================================================== */

function renderLista(){
  listaEl.innerHTML = "";
  currentItems.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "item";

    const info = document.createElement("div");
    info.style.flex = "1";
    info.innerHTML = `
      <strong>${it.codigo}</strong>
      <div class="muted">${it.descripcion}</div>
      <div class="muted">Cant: ${Number(it.cantidad).toFixed(3)}</div>
    `;

    const del = document.createElement("button");
    del.className = "small";
    del.textContent = "Eliminar";
    del.onclick = ()=>{ currentItems.splice(i,1); renderLista(); };

    div.appendChild(info);
    div.appendChild(del);
    listaEl.appendChild(div);
  });
}

agregarBtn.onclick = ()=>{
  const q = buscador.value.trim();
  const c = parseFloat(cantidadEl.value) || 0;
  if(!q || c <= 0) return alert("Ingresa un producto y una cantidad v√°lida");

  const [codigo, descripcion] = q.includes("|") ? q.split("|") : [q, q];

  currentItems.push({
    codigo: codigo.trim(),
    descripcion: descripcion.trim(),
    cantidad: c
  });

  buscador.value = "";
  cantidadEl.value = "";
  renderLista();
};




/* =====================================================
   =============== MANEJO DE FOTOS =====================
   ===================================================== */

abrirCamaraBtn.onclick = async ()=>{
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
    preview.style.display = "none";
    capturarBtn.style.display = "none";
    return;
  }
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    preview.srcObject = stream;
    preview.style.display = "block";
    capturarBtn.style.display = "inline-block";
  }catch{
    alert("No se pudo abrir la c√°mara");
  }
};

capturarBtn.onclick = ()=>{
  if(!stream) return;

  const v = preview;
  const canvas = document.createElement("canvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  canvas.getContext("2d").drawImage(v,0,0);

  const data = canvas.toDataURL("image/jpeg",0.75);
  addPhoto(data);
};

subirDesdeArchivo.onclick = ()=> filePhoto.click();

filePhoto.onchange = e=>{
  const f = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ()=> addPhoto(reader.result);
  reader.readAsDataURL(f);
};


function addPhoto(data){
  currentPhotos.push({data, ts:Date.now()});
  renderPhotos();
}

function renderPhotos(){
  photosEl.innerHTML = "";
  currentPhotos.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className = "item";

    const img = document.createElement("img");
    img.src = p.data;
    div.appendChild(img);

    const info = document.createElement("div");
    info.style.flex = "1";
    info.innerHTML = `<div class="muted">${new Date(p.ts).toLocaleString()}</div>`;

    const del = document.createElement("button");
    del.className = "small";
    del.textContent = "Eliminar";
    del.onclick = ()=>{ currentPhotos.splice(i,1); renderPhotos(); };

    div.appendChild(info);
    div.appendChild(del);
    photosEl.appendChild(div);
  });
}




/* =====================================================
   ============ GUARDAR VISITA FIRESTORE ===============
   ===================================================== */

function genId(suc){
  const f = new Date();
  return `AUD-${suc}-${f.getFullYear()}${(f.getMonth()+1)}${f.getDate()}-${f.getHours()}${f.getMinutes()}${f.getSeconds()}`;
}

function dataURLtoBlob(dataurl){
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]); let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr],{type:mime});
}

guardarVisita.onclick = async()=>{

  if(!auditorEl.value.trim()) return alert("Ingresa nombre del auditor");
  if(currentItems.length === 0) return alert("Agrega art√≠culos revisados");

  const suc = sucursalEl.value;
  const idVisita = genId(suc);

  try{
    // Crear documento de visita
    const refVisita = db.collection("auditorias")
                        .doc(suc)
                        .collection("registros")
                        .doc(idVisita);

    await refVisita.set({
      sucursal: suc,
      auditor: auditorEl.value.trim(),
      fecha: fechaEl.value,
      notas: notasEl.value.trim(),
      items: currentItems,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Subir fotos
    for(let i=0;i<currentPhotos.length;i++){
      const p=currentPhotos[i];
      const blob=dataURLtoBlob(p.data);
      const filePath=`auditorias/${suc}/${idVisita}/photos/${Date.now()}_${i}.jpg`;
      const snap=await storage.ref(filePath).put(blob);
      const url=await snap.ref.getDownloadURL();
      await refVisita.collection("photos").add({
        url,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    resumenEl.textContent = `Visita guardada (${idVisita})`;
    alert("Auditor√≠a guardada con √©xito");

  }catch(e){
    console.error(e);
    alert("Error guardando auditor√≠a");
  }

};




/* =====================================================
   ============= GENERAR PDF PROFESIONAL ===============
   ===================================================== */

generarPDF.onclick = ()=>{
  if(currentItems.length === 0 && currentPhotos.length === 0)
    return alert("Nada que exportar");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","pt","a4");

  pdf.setFont("Helvetica");
  pdf.setFontSize(18);
  pdf.setTextColor("#00416A");
  pdf.text(`Auditor√≠a ‚Äì ${sucursalEl.value}`, 40, 50);

  pdf.setFontSize(12);
  pdf.setTextColor("#000");
  pdf.text(`Auditor: ${auditorEl.value}`, 40, 80);
  pdf.text(`Fecha: ${fechaEl.value}`, 40, 100);

  let y = 130;
  pdf.setFontSize(14);
  pdf.text("Art√≠culos Revisados",40,y); y+=20;

  pdf.setFontSize(11);
  currentItems.forEach((it,idx)=>{
    pdf.text(`${idx+1}. ${it.codigo} ‚Äì ${it.descripcion}  Cant: ${it.cantidad}`,40,y);
    y+=14;
    if(y > 750){ pdf.addPage(); y=40; }
  });

  if(currentPhotos.length){
    pdf.addPage(); y=40;
    pdf.setFontSize(14);
    pdf.text("Evidencias Fotogr√°ficas",40,y); y+=20;

    for(let p of currentPhotos){
      try{
        pdf.addImage(p.data,"JPEG",40,y,220,150);
        y+=170;
        if(y>720){ pdf.addPage(); y=40; }
      }catch{}
    }
  }

  pdf.save(`auditoria_${sucursalEl.value}_${fechaEl.value}.pdf`);
};




/* =====================================================
   =============== NUEVA VISITA ========================
   ===================================================== */

nuevaVisita.onclick = ()=>{
  currentItems = [];
  currentPhotos = [];
  notasEl.value = "";
  auditorEl.value = "";
  renderLista();
  renderPhotos();
  resumenEl.textContent = "Lista vac√≠a.";
};




/* =====================================================
   ============ ESC√ÅNER POR C√ÅMARA =====================
   ===================================================== */

const buscarCamara = document.getElementById("buscarCamara");
const scanFile = document.getElementById("scanFile");

buscarCamara.onclick = async()=>{

  if(!("BarcodeDetector" in window)){
    scanFile.click();
    return;
  }

  try{
    const streamLocal = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    const videoTmp = document.createElement("video");
    videoTmp.srcObject = streamLocal;
    videoTmp.autoplay = true;
    videoTmp.playsInline = true;

    await videoTmp.play();

    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");
    const detector = new BarcodeDetector({
      formats:["ean_13","ean_8","code_128","qr_code"]
    });

    let code=null;

    for(let i=0;i<25 && !code;i++){
      if(videoTmp.videoWidth===0){
        await new Promise(r=>setTimeout(r,120));
        continue;
      }
      canvas.width=videoTmp.videoWidth;
      canvas.height=videoTmp.videoHeight;
      ctx.drawImage(videoTmp,0,0);

      try{
        const res = await detector.detect(canvas);
        if(res.length) code=res[0].rawValue;
      }catch{}

      await new Promise(r=>setTimeout(r,100));
    }

    streamLocal.getTracks().forEach(t=>t.stop());

    if(!code) return alert("No se detect√≥ ning√∫n c√≥digo");

    const found = productos.find(p =>
      p.codigo === code ||
      p.equivalentes.includes(code)
    );

    if(found){
      buscador.value = `${found.codigo}|${found.descripcion}`;
    }else{
      buscador.value = `${code}|`;
    }

  }catch(e){
    alert("Error: "+e.message);
  }
};

scanFile.onchange = async e=>{
  const f = e.target.files[0];
  if(!f) return;

  try{
    const imgBitmap = await createImageBitmap(f);
    const canvas=document.createElement("canvas");
    canvas.width = imgBitmap.width;
    canvas.height = imgBitmap.height;
    canvas.getContext("2d").drawImage(imgBitmap,0,0);

    if(!("BarcodeDetector" in window)){
      return alert("BarcodeDetector no disponible");
    }

    const detector = new BarcodeDetector({
      formats:["ean_13","code_128","upc_a"]
    });

    const res = await detector.detect(canvas);

    if(!res.length) return alert("No se detect√≥ c√≥digo");

    const val = res[0].rawValue;

    const found = productos.find(p =>
      p.codigo === val ||
      p.equivalentes.includes(val)
    );

    buscador.value = found
      ? `${found.codigo}|${found.descripcion}`
      : `${val}|`;

  }catch(e){
    alert("Error al procesar imagen");
  }
};

</script>

</body>
</html>
